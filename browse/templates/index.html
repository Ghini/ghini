{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Ghini - Taxasoft BG</title>
    <meta name="author" content="Mario Frasca" >
    <meta name="copyright" content="Mario Frasca">
    <meta name="License" content="AGPL3">
    <meta name="description" content="">
    <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8">
    <meta http-equiv="content-style-type" content="text/css">
    <meta http-equiv="expires" content="0">

    <!-- CSS libraries-->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/bootstrap-datepicker.min.css' %}" integrity="sha256-JDBcnYeV19J14isGd3EtnsCQK05d8PczJ5+fvEvBJvI=" crossorigin="anonymous" />
    <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}" crossorigin="anonymous">
    <!-- ./ CSS libraries-->
    <!-- JS libraries -->
    <script src="{% static 'js/jquery-3.3.1.min.js' %}" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="{% static 'js/popper.min.js' %}" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="{% static 'js/bootstrap.min.js' %}" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="{% static 'js/bootstrap-datepicker.min.js' %}" integrity="sha256-tW5LzEC7QjhG0CiAvxlseMTs2qJS7u3DRPauDjFJ3zo=" crossorigin="anonymous"></script>
    <!-- ./ JS libraries -->
    <script>
     var search_history, forward_history;

     function partial(func, ...argsBound) {
         return function(...args) { // (*)
             return func.call(this, ...argsBound, ...args);
         }
     }

     function replace_search_filter(value, e) {
         $('#search-filter').val(value);
         $('#search-filter-button').trigger('click');
     }

     function activate_infobox(url, e) {
         $(e.target).attr("disabled", "disabled");
         $('#infobox-object-text').empty();
         $('#infobox-object-text').append($(e.target).clone());
         var tbody = $('#infobox-table-body');
         tbody.empty();
         console.log(e.target.childNodes[0].data);
         $.getJSON(url, function(data) {
             tbody.empty();
             var tr, td;
             jQuery.each(data, function(key, value) {
                 if (value !== null && value !== '') {
                     tr = $("<tr></tr>");
                     tbody.append(tr);  // add it as last child
                     tr.append($('<td width="40%">' + key + '</td>'));
                     if(value[0] === 'link') {
                         td = $('<td>' + value[1] + '</td>');
                         td.click(partial(replace_search_filter, value[2]));
                         td.addClass('list-group-item-action');
                         tr.append(td);
                     } else {
                         tr.append($('<td>' + value + '</td>'));
                     }
                 }
             });
             $(e.target).removeAttr("disabled");
         });
     }

     if (!Array.prototype.last){
         Array.prototype.last = function(){
             return this[this.length - 1];
         };
     };

     function clean_history(e) {
         search_history.length = 0;
         forward_history.length = 0;
         $('#search-filter').val('');
         $('#infobox-object-text').empty();
         $('#infobox-table-body').empty();
         $('#results-table-body').empty();
     }

     function lookup(e, term) {
         $('.search-filter').attr("disabled", "disabled");
         if(term === undefined) {
             term = $('#search-filter').val();
             if(search_history.last() !== term && forward_history.last() !== term)
                 search_history.push(term);
         } else {
             $('#search-filter').val(term);
         }
         $('#infobox-object-text').empty();
         $('#infobox-table-body').empty();
         var tbody = $('#results-table-body');
         tbody.empty();

         api_url = '/browse/filter/?q=' + $('#search-filter').val();
         $.getJSON(api_url, function(data) {
             var tr, td;
             var added_count = 0;
             jQuery.each(data, function(class_name, list_for_class) {
                 console.log(class_name, list_for_class);
                 jQuery.each(list_for_class, function(index, item) {
                     added_count += 1;
                     tr = $("<tr></tr>");
                     td = $('<td>' + item.inline + '</td>');
                     tbody.append(tr);  // add it as last child
                     tr.append(td);
                     td.click(partial(activate_infobox, item.infobox_url))
                 });
             });
             if (added_count === 1) {
                 td.trigger('click');
             }
             $('.search-filter').removeAttr("disabled");
         })
     }

     function follow_history(to_pop, to_push, e) {
         if(to_pop.length !== 0) {
             var term = to_pop.pop();
             to_push.push(term);
             if ($('#search-filter').val() === term && to_pop.length !== 0) {
                 term = to_pop.pop();
                 to_push.push(term);
             }

             lookup(e, term);
         }
     }

     $(function() {  // run at document ready
         $('#search-filter').on('keypress', function (e) {
             if(e.which === 13) {
                 lookup(e);
             }
         });
         $('#search-filter-button').click(lookup);
         search_history = [];
         forward_history = [];
         $('#pop-from-history').click(partial(follow_history, search_history, forward_history));
         $('#forward-in-history').click(partial(follow_history, forward_history, search_history));
         $('#clean-history').click(clean_history);

         $("body").bind('contextmenu', function (e) {
             e.preventDefault(); // prevents default menu
         });
     });
    </script>
  </head>
  <body class="container-fluid">
    <div class="input-group search-filter">
      <button class="btn btn-light" id="pop-from-history">
        <span class="fa fa-arrow-left"></span>
      </button>
      <button class="btn btn-light" id="forward-in-history">
        <span class="fa fa-arrow-right"></span>
      </button>
      <button class="btn btn-light" id="clean-history">
        <span class="fa fa-paint-brush"></span>
      </button>
      <button class="btn" disabled>lookup:</button>
      <input type="text" class="form-control" id="search-filter">
      <button class="btn btn-primary" id="search-filter-button">
        <span class="fa fa-refresh"></span>
      </button>
      <button class="btn btn-primary">
        <span class="fa fa-gears"></span>
      </button>
      <button class="btn btn-primary">
        <span class="fa fa-home"></span>
      </button>
    </div>

    <div class="row">
      <div class="col-7">
        <table class="table">
          <thead>
            <tr>
              <th>results list</th>
            </tr>
          </thead>
        </table>
      </div>
      <div class="col-5">
        <table class="table">
          <thead>
            <tr>
              <th>info box for selected row</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>

    <div class="row">
      <div class="col-7" style="height:520px;overflow-y:scroll">
        <table class="table table-hover">
          <tbody id="results-table-body">
          </tbody>
        </table>
      </div>
      <div class="col-5">
        <h5 id="infobox-object-text"></h5>
        <table class="table">
          <tbody id="infobox-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </body>
</html>
